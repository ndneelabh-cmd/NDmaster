<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Clone | Universal AI Interface</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f0f4f9',
                            100: '#e1e5ea',
                            800: '#1e1f20',
                            900: '#131314', // Deep dark
                            accent: '#444746'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Loader Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile safe area */
        body, html { height: 100dvh; overflow: hidden; }

        /* Markdown Styling Overrides */
        .prose pre { padding: 0; margin: 0.5em 0; border-radius: 0.5rem; background: #1e1e1e; }
        .prose code { color: #eb5757; background: rgba(135,131,120,0.15); padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.9em; }
        .prose pre code { color: inherit; background: transparent; padding: 1em; display: block; overflow-x: auto; }
        .dark .prose code { color: #ff7b72; background: rgba(110,118,129,0.4); }
        .dark .prose strong { color: #e2e8f0; }
        .dark .prose p { color: #cbd5e1; }
        .dark .prose { color: #cbd5e1; }
    </style>
</head>
<body class="bg-gemini-50 text-slate-800 dark:bg-gemini-900 dark:text-slate-200 transition-colors duration-200">

    <div id="app-loader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white dark:bg-gemini-900">
        <div class="loader mb-4"></div>
        <div class="text-sm font-medium text-slate-500 animate-pulse">Initializing Interface...</div>
    </div>

    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 transform -translate-x-full md:translate-x-0 md:static md:flex flex-col bg-gemini-50 dark:bg-gemini-900 border-r border-slate-200 dark:border-slate-700 transition-transform duration-300 ease-in-out">
            
            <div class="p-4 flex items-center justify-between">
                <button onclick="app.newChat()" class="flex-1 flex items-center gap-2 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 px-4 py-2.5 rounded-full text-sm font-medium transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
                <button onclick="app.toggleSidebar()" class="md:hidden ml-2 p-2 text-slate-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history-list">
                </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="app.openSettings()" class="flex items-center gap-3 w-full p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-lg transition-colors text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full bg-white dark:bg-gemini-900 relative">
            
            <header class="flex items-center justify-between p-4 md:hidden border-b border-slate-100 dark:border-slate-800">
                <button onclick="app.toggleSidebar()" class="p-2 -ml-2 text-slate-600 dark:text-slate-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <span class="font-medium text-slate-700 dark:text-slate-200">Gemini Clone</span>
                <div class="w-8"></div> </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
                <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-60">
                    <div class="w-16 h-16 bg-gradient-to-tr from-blue-400 to-red-400 rounded-full blur-xl opacity-50"></div>
                    <h2 class="text-2xl font-semibold text-slate-700 dark:text-slate-200">How can I help you today?</h2>
                </div>
            </div>

            <div class="p-4 bg-white dark:bg-gemini-900">
                <div class="max-w-4xl mx-auto relative group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-3xl blur-md opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <form onsubmit="app.handleSubmit(event)" class="relative flex items-end gap-2 bg-slate-100 dark:bg-[#1e1f20] rounded-3xl p-3 border border-transparent focus-within:border-slate-300 dark:focus-within:border-slate-600 focus-within:bg-white dark:focus-within:bg-[#252627] transition-all shadow-sm">
                        <textarea 
                            id="user-input" 
                            rows="1" 
                            class="w-full bg-transparent border-0 focus:ring-0 resize-none max-h-32 py-2 px-2 text-slate-800 dark:text-slate-100 placeholder-slate-500" 
                            placeholder="Message Gemini Clone..."
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            onkeydown="app.handleEnter(event)"></textarea>
                        
                        <button type="submit" id="send-btn" class="p-2 bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-300 rounded-full hover:bg-blue-500 hover:text-white dark:hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                        </button>
                    </form>
                    <div class="text-center mt-2 text-xs text-slate-400 dark:text-slate-500">
                        AI can make mistakes. Verify important info.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="app.closeSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-[#1e1f20] rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 p-6">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Settings</h3>
            
            <div class="flex items-center justify-between mb-6">
                <span class="text-slate-700 dark:text-slate-300">Dark Mode</span>
                <button onclick="app.toggleTheme()" id="theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <span class="translate-x-1 inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">OpenRouter API Key</label>
                <input type="password" id="api-key-input" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="sk-or-...">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Model Name</label>
                <input type="text" id="model-input" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="deepseek/deepseek-r1:free">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">System Instructions</label>
                <textarea id="system-prompt-input" rows="3" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="You are a helpful assistant..."></textarea>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="app.closeSettings()" class="px-4 py-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">Cancel</button>
                <button onclick="app.saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        /**
         * Core Application Logic
         * Implements a singleton pattern for state management
         */
        const app = {
            state: {
                chats: [],
                currentChatId: null,
                apiKey: '',
                model: 'deepseek/deepseek-r1:free',
                systemPrompt: '',
                darkMode: false,
                isGenerating: false
            },

            init() {
                // Load State
                const saved = JSON.parse(localStorage.getItem('gemini_clone_state') || '{}');
                this.state = { ...this.state, ...saved };
                
                // If no chats, create one, but don't save yet until message sent to avoid spam
                if (!this.state.chats.length) {
                    this.createChat(false);
                } else if (!this.state.currentChatId) {
                    this.state.currentChatId = this.state.chats[0].id;
                }

                // Apply Theme
                this.applyTheme();

                // Fill Settings Inputs
                document.getElementById('api-key-input').value = this.state.apiKey;
                document.getElementById('model-input').value = this.state.model;
                document.getElementById('system-prompt-input').value = this.state.systemPrompt;

                // Render
                this.renderChatList();
                this.renderMessages();

                // Setup Marked
                marked.setOptions({
                    highlight: function(code, lang) {
                        const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                        return highlight.highlight(code, { language }).value;
                    },
                    breaks: true
                });

                // Remove Loader
                setTimeout(() => {
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('app').style.opacity = '1';
                }, 500);
            },

            saveState() {
                localStorage.setItem('gemini_clone_state', JSON.stringify(this.state));
            },

            // --- Theme Management ---
            toggleTheme() {
                this.state.darkMode = !this.state.darkMode;
                this.applyTheme();
                this.saveState();
            },

            applyTheme() {
                const html = document.documentElement;
                const toggle = document.querySelector('#theme-toggle span');
                const toggleBtn = document.querySelector('#theme-toggle');
                
                if (this.state.darkMode) {
                    html.classList.add('dark');
                    toggle.classList.add('translate-x-6');
                    toggle.classList.remove('translate-x-1');
                    toggleBtn.classList.replace('bg-slate-200', 'bg-blue-600');
                } else {
                    html.classList.remove('dark');
                    toggle.classList.remove('translate-x-6');
                    toggle.classList.add('translate-x-1');
                    toggleBtn.classList.replace('bg-blue-600', 'bg-slate-200');
                }
            },

            // --- Chat Management ---
            createChat(switchTo = true) {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'New Chat',
                    messages: [],
                    timestamp: Date.now()
                };
                this.state.chats.unshift(newChat);
                if (switchTo) {
                    this.state.currentChatId = newChat.id;
                    this.closeSidebar(); // On mobile
                }
                this.saveState();
                this.renderChatList();
                this.renderMessages();
            },

            deleteChat(id, event) {
                event.stopPropagation();
                if(!confirm('Delete this chat?')) return;
                
                this.state.chats = this.state.chats.filter(c => c.id !== id);
                if (this.state.currentChatId === id) {
                    this.state.currentChatId = this.state.chats.length > 0 ? this.state.chats[0].id : null;
                    if (!this.state.currentChatId) this.createChat();
                }
                this.saveState();
                this.renderChatList();
                this.renderMessages();
            },

            selectChat(id) {
                this.state.currentChatId = id;
                this.saveState();
                this.renderChatList();
                this.renderMessages();
                this.closeSidebar();
            },

            getCurrentChat() {
                return this.state.chats.find(c => c.id === this.state.currentChatId);
            },

            // --- UI Rendering ---
            renderChatList() {
                const list = document.getElementById('chat-history-list');
                list.innerHTML = this.state.chats.map(chat => `
                    <div onclick="app.selectChat('${chat.id}')" class="group flex items-center justify-between p-3 rounded-full cursor-pointer transition-colors ${chat.id === this.state.currentChatId ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200' : 'hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300'}">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                            <span class="truncate text-sm font-medium">${chat.title}</span>
                        </div>
                        <button onclick="app.deleteChat('${chat.id}', event)" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `).join('');
            },

            renderMessages() {
                const chat = this.getCurrentChat();
                const container = document.getElementById('chat-container');
                const welcome = document.getElementById('welcome-message');
                
                if (!chat || chat.messages.length === 0) {
                    container.innerHTML = '';
                    if(welcome) container.appendChild(welcome);
                    welcome.style.display = 'flex';
                    return;
                }
                
                welcome.style.display = 'none';
                
                // Rebuild DOM only if needed or just append? For simplicity in Zero-Build, we rebuild.
                // Note: For a real huge app, we'd use virtual DOM. Here, vanilla JS string interpolation is fast enough.
                container.innerHTML = chat.messages.map(msg => `
                    <div class="flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[85%] md:max-w-[75%] rounded-2xl px-5 py-3.5 shadow-sm 
                            ${msg.role === 'user' 
                                ? 'bg-[#f0f4f9] dark:bg-[#2e2f30] text-slate-800 dark:text-slate-100 rounded-br-none' 
                                : 'text-slate-800 dark:text-slate-100'}">
                            
                            ${msg.role === 'assistant' 
                                ? `<div class="flex items-center gap-2 mb-2">
                                     <div class="w-6 h-6 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>
                                     </div>
                                     <span class="font-semibold text-xs text-slate-500">Gemini</span>
                                   </div>` 
                                : ''}
                            
                            <div class="prose dark:prose-invert max-w-none text-sm leading-relaxed">
                                ${msg.role === 'user' ? msg.content.replace(/\n/g, '<br>') : marked.parse(msg.content)}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                this.scrollToBottom();
            },

            scrollToBottom() {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            },

            // --- Messaging Logic ---
            handleEnter(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.handleSubmit(e);
                }
            },

            async handleSubmit(e) {
                if (e) e.preventDefault();
                if (this.state.isGenerating) return;

                const input = document.getElementById('user-input');
                const text = input.value.trim();
                
                if (!text) return;
                if (!this.state.apiKey) {
                    this.openSettings();
                    alert('Please enter your OpenRouter API Key first.');
                    return;
                }

                // UI Updates
                input.value = '';
                input.style.height = 'auto';
                this.state.isGenerating = true;
                document.getElementById('send-btn').disabled = true;

                // Add User Message
                const chat = this.getCurrentChat();
                chat.messages.push({ role: 'user', content: text });
                
                // Auto-rename chat if it's the first message
                if (chat.messages.length === 1) {
                    chat.title = text.slice(0, 30) + (text.length > 30 ? '...' : '');
                    this.renderChatList();
                }

                this.renderMessages();
                this.saveState();

                // Create placeholder for Assistant Message
                const aiMsgIndex = chat.messages.push({ role: 'assistant', content: '' }) - 1;
                
                // Prepare Request
                const messages = [
                    ...(this.state.systemPrompt ? [{ role: 'system', content: this.state.systemPrompt }] : []),
                    ...chat.messages.slice(0, -1) // Send context
                ];

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${this.state.apiKey}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.href, 
                            "X-Title": "Gemini Clone"
                        },
                        body: JSON.stringify({
                            model: this.state.model,
                            messages: messages,
                            stream: true
                        })
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    // Stream Handling
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let buffer = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split("\n");
                        buffer = lines.pop(); // Keep incomplete line

                        for (const line of lines) {
                            if (line.trim() === "") continue;
                            if (line.includes("[DONE]")) break;
                            
                            if (line.startsWith("data: ")) {
                                try {
                                    const json = JSON.parse(line.slice(6));
                                    const delta = json.choices[0].delta.content || "";
                                    chat.messages[aiMsgIndex].content += delta;
                                    
                                    // Live update UI
                                    this.updateLastMessage(chat.messages[aiMsgIndex].content);
                                } catch (err) {
                                    console.error("Stream parse error", err);
                                }
                            }
                        }
                    }

                } catch (error) {
                    chat.messages[aiMsgIndex].content = `**Error:** ${error.message}. Please check your API key.`;
                    this.renderMessages();
                } finally {
                    this.state.isGenerating = false;
                    document.getElementById('send-btn').disabled = false;
                    this.saveState();
                    // One final render to ensure markdown parsing completes perfectly
                    this.renderMessages(); 
                }
            },

            // Optimized update for streaming (avoids full re-render)
            updateLastMessage(content) {
                const container = document.getElementById('chat-container');
                const lastBubble = container.lastElementChild.querySelector('.prose');
                if (lastBubble) {
                    lastBubble.innerHTML = marked.parse(content);
                    this.scrollToBottom();
                }
            },

            // --- Sidebar / Settings ---
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                } else {
                    sidebar.classList.add('-translate-x-full');
                }
            },

            closeSidebar() {
                const sidebar = document.getElementById('sidebar');
                // Only close if we are in mobile view (checked by class presence usually, but here force close is safe)
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                }
            },

            openSettings() {
                document.getElementById('settings-modal').style.display = 'block';
                // Sync specific inputs
                document.getElementById('api-key-input').value = this.state.apiKey;
            },

            closeSettings() {
                document.getElementById('settings-modal').style.display = 'none';
            },

            saveSettings() {
                this.state.apiKey = document.getElementById('api-key-input').value.trim();
                this.state.model = document.getElementById('model-input').value.trim() || 'deepseek/deepseek-r1:free';
                this.state.systemPrompt = document.getElementById('system-prompt-input').value.trim();
                this.saveState();
                this.closeSettings();
                this.createChat(); // Start fresh with new settings
            },
            
            newChat() {
                this.createChat(true);
            }
        };

        // Initialize App on Load
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
